#!/bin/bash
#
# Managed by ansible (mit.webserver.php)
# DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
#
# Sets correct file permissions for shared web projects.
#
# Create /etc/update-facls.conf with dir, user and group, e.g.:
# /srv/www/monheim.de/www-dev/htdocs www-dev monheim
#
# - Calling without parameters processes all configured directories.
# - Calling with parameter "dir" processes only the specified directory (which
#     still must be set in /etc/update-facls.conf).
# - Calling with parameter "dir" and "--updateOwnerAndGroupOnly" updates only
#     the owner and group of the the specified directory.
#
# 2023-09-13, markus.meissner@meissner.IT
# 2024-12-13: Added parameter --updateOwnerAndGroupOnly

# exit on error (equals set -o errexit)
set -e

# No config file no work to do
[ -f /etc/update-facls.conf ] || exit 0

function updateOwnerAndGroup {
    # exit if variable is unset
    set -u
    DIR=$1
    OWNER=$2
    GROUP=$3
    cd ${DIR}
    if [[ "${OWNER}" = "donotchange" ]]; then
        chgrp -R ${GROUP} ${DIR}
    else
        chown -R ${OWNER}:${GROUP} ${DIR}
    fi
}

function updateFacls {
    # exit if variable is unset
    set -u
    DIR=$1
    OWNER=$2
    GROUP=$3
    cd ${DIR}
    chmod -R o-w ${DIR}
    find ${DIR} -type f -exec setfacl -m g:${GROUP}:rw {} \;
    find ${DIR} -type d \
            -exec chmod ug+rwx {} \; \
            -exec setfacl -m g:${GROUP}:rwx {} \; \
            -exec setfacl -d -m g:${GROUP}:rwx {} \;
}

if [ -z "$1" ]; then
    while read -r line; do
        IFS=' ' read -a array <<< "$line"
        updateOwnerAndGroup ${array[0]} ${array[1]} ${array[2]}
        updateFacls ${array[0]} ${array[1]} ${array[2]}
    done < /etc/update-facls.conf
else
    processed=0
    while read -r line; do
        if [[ "$line" =~ ^$1.* ]]; then
            IFS=' ' read -a array <<< "$line"
            if [ -z $2 ]; then
                echo "Updating owner, group and facls of '${array[0]}' with user '${array[1]}' and group '${array[2]}'"
                updateOwnerAndGroup ${array[0]} ${array[1]} ${array[2]}
                updateFacls ${array[0]} ${array[1]} ${array[2]}
            elif [[ "$2" = "--updateOwnerAndGroupOnly" ]]; then
                echo "Updating owner and group of '${array[0]}' with user '${array[1]}' and group '${array[2]}'"
                updateOwnerAndGroup ${array[0]} ${array[1]} ${array[2]}
            else
                echo "Unknown option $2"
                exit 1
            fi
            processed=1
        fi
    done < /etc/update-facls.conf
    if [[ "$processed" -eq 0 ]]; then
        echo "Could not read '$1' from /etc/update-facls.conf"
        exit 1
    fi
fi
